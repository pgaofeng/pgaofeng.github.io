<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta content="width=device-width,initial-scale=1,minimum-scale=1" name="viewport"><meta content="ie=edge" http-equiv="X-UA-Compatible"><meta content="#fff" name="theme-color" id="theme-color"><meta content="Hexo" name="description"><link href="/img/website.svg" rel="icon"><title>App管理服务-ActivityManagerService</title><link href="/css/main.css" rel="preload" as="style"><link href="/css/main.css" rel="stylesheet"><link href="/css/libs/atom-one-light.min.css" rel="preload" as="style"><link href="/css/libs/atom-one-light.min.css" rel="stylesheet"><script>function loadScript(e,t){var n=document.createElement("script");n.src=e,t&&(n.onload=t),n.async=!0,document.body.appendChild(n)}function loadCSS(e){var t=document.createElement("link");t.ref="stylesheet",t.href=e,document.head.appendChild(t)}function changeCSS(e,t,n){var t=document.querySelector(t),c=document.createElement("link");c.setAttribute("rel","stylesheet"),c.setAttribute("href",e),c.dataset.prism=n,document.head.replaceChild(c,t)}</script><link href="/js/lib/lozad.min.js" rel="preload" as="script"><meta content="Hexo 7.3.0" name="generator"></head><body><div class="wrapper"><nav class="navbar"><div class="nav-container"><div class="navbar-menu"><a href="/" class="navbar-menu-item">首页 </a><a href="/archives" class="navbar-menu-item">归档 </a><a href="/tags" class="navbar-menu-item">标签 </a><a href="/categories" class="navbar-menu-item">分类</a></div></div></nav><div class="section-wrap"><div class="container"><div class="columns"><aside class="left-column"><div class="card card-author"><img alt="author avatar" class="author-img" src="/img/website.svg" height="88" width="88"><p class="author-name">pppeng</p><p class="author-description">一日不书 百事荒芜</p><div class="author-message"><a href="/archives" class="author-posts-count"><span>29</span> <span>文章</span> </a><a href="/categories" class="author-categories-count"><span>4</span> <span>分类</span> </a><a href="/tags" class="author-tags-count"><span>15</span> <span>标签</span> </a><a class="author-word-count"><span>11.68</span> <span>万字</span></a></div></div><div class="sticky-tablet"><article class="display-when-two-columns spacer"><div class="card card-content toc-card"><div class="toc-header">目录</div><ol class="toc"><li class="toc-item toc-level-3"><a href="#ActivityManagerService" class="toc-link"><span class="toc-text">ActivityManagerService</span></a></li></ol></div></article><article class="card card-content categories-widget"><div class="categories-card"><div class="categories-header">分类</div><div class="categories-list"><a href="/categories/Android-Framework/"><div class="categories-list-item">Android Framework <span class="categories-list-item-badge">12</span></div></a><a href="/categories/Android-View/"><div class="categories-list-item">Android View <span class="categories-list-item-badge">4</span></div></a><a href="/categories/Third-Libraries/"><div class="categories-list-item">Third Libraries <span class="categories-list-item-badge">7</span></div></a><a href="/categories/Kotlin/"><div class="categories-list-item">Kotlin <span class="categories-list-item-badge">6</span></div></a></div></div></article></div></aside><main class="main-column"><div class="image-wrapper"><img alt="App管理服务-ActivityManagerService thumbnail" class="image lozad" src="/img/cover/cover-ams.webp" data-src="</%= page.banner_img " srcset="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc4MDAnIGhlaWdodD0nMjQwJz48cmVjdCB4PScwJyB5PScwJyB3aWR0aD0nODAwJyBoZWlnaHQ9JzI0MCcgZmlsbD0nI2ZhZmFmYScvPjx0ZXh0IHg9JzUwJScgeT0nNTAlJyBzdHlsZT0nZG9taW5hbnQtYmFzZWxpbmU6bWlkZGxlO3RleHQtYW5jaG9yOm1pZGRsZTtmb250LXNpemU6NTNweCcgZmlsbD0nI2I3YjdiNyc+5Zu+54mH5Yqg6L295LitPC90ZXh0Pjwvc3ZnPg=="></div><article class="card card-content article-content"><header><h1 class="post-title">App管理服务-ActivityManagerService</h1></header><div class="post-meta post-show-meta"><time datetime="2022-10-02T07:21:11.000Z"><i class="icon-calendar iconfont" style="margin-right:2px"></i> <span>2022-10-02</span> </time><span class="dot"></span> <a href="/categories/Android-Framework/" class="post-meta-link">Android Framework </a><span class="dot"></span> <span>约1.5k 字</span></div><div class="post-content" id="section"><p><code>ActivityManagerService</code>（俗称<code>AMS</code>）是一个非常重要的系统服务，它是在<code>SystemServer</code>中被启动的进程之一。作用及其广泛，主管的就是应用<code>App</code>的四大组件以及进程信息，可以说它管理着<code>app</code>世界的所有应用。<code>zygote</code>孵化所有<code>java</code>进程，<code>system_server</code>管理所有服务，<code>AMS</code>管理所有<code>app</code>进程。</p><blockquote><p>源码基于Android 13</p></blockquote><h3 id="ActivityManagerService"><a href="#ActivityManagerService" class="headerlink" title="ActivityManagerService"></a>ActivityManagerService</h3><p><code>AMS</code>作为一个系统服务，也是在<code>SystemServer</code>中启动的，并且属于是<code>bootstrap</code>类型的服务，会被添加到<code>WatchDog</code>的监控中。通常情况下，这些服务都是由<code>SystemServiceManager</code>通过反射启动的，这里也不例外。这里我们可以看下其启动流程：</p><figure class="java highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="java hljs"><span class="hljs-comment">// frameworks/base/services/java/com/android/server/SystemServer.java</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SystemServer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Dumpable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startBootstrapServices</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> TimingsTraceAndSlog t)</span> &#123;<br>        ...<br>        <span class="hljs-comment">// ATMS启动</span><br>        <span class="hljs-type">ActivityTaskManagerService</span> <span class="hljs-variable">atm</span> <span class="hljs-operator">=</span> mSystemServiceManager.startService(<br>                ActivityTaskManagerService.Lifecycle.class).getService();<br>        <span class="hljs-comment">// AMS启动</span><br>        mActivityManagerService = ActivityManagerService.Lifecycle.startService(<br>                mSystemServiceManager, atm);<br>        mActivityManagerService.setSystemServiceManager(mSystemServiceManager);<br>        mActivityManagerService.setInstaller(installer);<br>        ...<br>        <span class="hljs-comment">// 设置SystemServer进程</span><br>        mActivityManagerService.setSystemProcess();<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startOtherServices</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> TimingsTraceAndSlog t)</span> &#123;<br>        <span class="hljs-comment">// 安装provider</span><br>        mActivityManagerService.getContentProviderHelper().installSystemProviders();<br>        ...<br>        <span class="hljs-comment">// 设置WMS</span><br>        mActivityManagerService.setWindowManager(wm);<br>        ...<br>        <span class="hljs-comment">// AMS完成之后的回调</span><br>        mActivityManagerService.systemReady(() -&gt; &#123;<br>            <span class="hljs-comment">// 观测natice的崩溃</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                mActivityManagerService.startObservingNativeCrashes();<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>                reportWtf(<span class="hljs-string">&quot;observing native crashes&quot;</span>, e);<br>            &#125;<br>            ...<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里可以看到在启动<code>AMS</code>前还先启动了<code>ATMS</code>，然后作为参数传递给<code>AMS</code>进行启动。这里<code>ATMS</code>也是一个服务，它是由<code>AMS</code>拆分出来的专门管理<code>Activity</code>的一个服务，后面我们再单独查看，这里看下<code>AMS</code>的启动并不是直接启动的，而是经由了其<code>Lifecycle</code>间接启动。</p><figure class="java highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="java hljs"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IActivityManager</span>.Stub<br>        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Watchdog</span>.Monitor, BatteryStatsImpl.BatteryCallback, ActivityManagerGlobalLock &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Lifecycle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SystemService</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ActivityManagerService mService;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ActivityTaskManagerService sAtm;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Lifecycle</span><span class="hljs-params">(Context context)</span> &#123;<br>            <span class="hljs-built_in">super</span>(context);<br>            <span class="hljs-comment">// 2. 由SystemServiceManager反射走到构造方法中</span><br>            mService = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityManagerService</span>(context, sAtm);<br>        &#125;<br><br>        <span class="hljs-comment">// 1.从SystemServer中调用该方法进行启动</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ActivityManagerService <span class="hljs-title function_">startService</span><span class="hljs-params">(</span><br><span class="hljs-params">                SystemServiceManager ssm, ActivityTaskManagerService atm)</span> &#123;<br>            sAtm = atm;<br>            <span class="hljs-keyword">return</span> ssm.startService(ActivityManagerService.Lifecycle.class).getService();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">// 3. 构造出对象后调用其onStart</span><br>            mService.start();<br>        &#125;<br>        ...<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p><code>AMS</code>并不是直接被启动的，而是由其静态内部类<code>Lifecycle</code>创建并启动的。我们在前面知道，所有通过<code>SystemServiceManager</code>启动的服务都是会被添加到其内部的集合中的，因此这里添加到服务集合中的实际上是<code>AMS.Lifecycle</code>对象，只不过我们可以通过它间接获取到<code>AMS</code>而已。 接下来我们看其构造方法：</p><figure class="java highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="java hljs"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IActivityManager</span>.Stub<br>        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Watchdog</span>.Monitor, BatteryStatsImpl.BatteryCallback, ActivityManagerGlobalLock &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ActivityManagerService</span><span class="hljs-params">(Context systemContext, ActivityTaskManagerService atm)</span> &#123;<br>        <span class="hljs-comment">// systemServer线程</span><br>        mSystemThread = ActivityThread.currentActivityThread();<br>        mUiContext = mSystemThread.getSystemUiContext();<br><br>        <span class="hljs-comment">// HandlerThread线程</span><br>        mHandlerThread = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceThread</span>(TAG,<br>                THREAD_PRIORITY_FOREGROUND, <span class="hljs-literal">false</span> <span class="hljs-comment">/*allowIo*/</span>);<br>        mHandlerThread.start();<br>        mHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainHandler</span>(mHandlerThread.getLooper());<br>        <span class="hljs-comment">// UI线程的handler</span><br>        mUiHandler = mInjector.getUiHandler(<span class="hljs-built_in">this</span>);<br>       <br>        <span class="hljs-comment">// 进程管理</span><br>        mProcessList = mInjector.getProcessList(<span class="hljs-built_in">this</span>);<br>        mProcessList.init(<span class="hljs-built_in">this</span>, activeUids, mPlatformCompat);<br>        <span class="hljs-comment">// 性能管理</span><br>        mAppProfiler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppProfiler</span>(<span class="hljs-built_in">this</span>, BackgroundThread.getHandler().getLooper(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">LowMemDetector</span>(<span class="hljs-built_in">this</span>));<br>        mPhantomProcessList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhantomProcessList</span>(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-comment">// oom_adj用于杀进程的</span><br>        mOomAdjuster = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OomAdjuster</span>(<span class="hljs-built_in">this</span>, mProcessList, activeUids);<br><br>        <span class="hljs-comment">// 广播管理</span><br>        ...<br>        mFgBroadcastQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastQueue</span>(<span class="hljs-built_in">this</span>, mHandler,<br>                <span class="hljs-string">&quot;foreground&quot;</span>, foreConstants, <span class="hljs-literal">false</span>);<br>        mBgBroadcastQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastQueue</span>(<span class="hljs-built_in">this</span>, mHandler,<br>                <span class="hljs-string">&quot;background&quot;</span>, backConstants, <span class="hljs-literal">true</span>);<br>        mBgOffloadBroadcastQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastQueue</span>(<span class="hljs-built_in">this</span>, mHandler,<br>                <span class="hljs-string">&quot;offload_bg&quot;</span>, offloadConstants, <span class="hljs-literal">true</span>);<br>        mFgOffloadBroadcastQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastQueue</span>(<span class="hljs-built_in">this</span>, mHandler,<br>                <span class="hljs-string">&quot;offload_fg&quot;</span>, foreConstants, <span class="hljs-literal">true</span>);<br>        mBroadcastQueues[<span class="hljs-number">0</span>] = mFgBroadcastQueue;<br>        mBroadcastQueues[<span class="hljs-number">1</span>] = mBgBroadcastQueue;<br>        mBroadcastQueues[<span class="hljs-number">2</span>] = mBgOffloadBroadcastQueue;<br>        mBroadcastQueues[<span class="hljs-number">3</span>] = mFgOffloadBroadcastQueue;<br>        <span class="hljs-comment">// Service管理</span><br>        mServices = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActiveServices</span>(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-comment">// ContentProvider管理</span><br>        mCpHelper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentProviderHelper</span>(<span class="hljs-built_in">this</span>, <span class="hljs-literal">true</span>);<br>        mPackageWatchdog = PackageWatchdog.getInstance(mUiContext);<br>        <span class="hljs-comment">// app崩溃管理</span><br>        mAppErrors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppErrors</span>(mUiContext, <span class="hljs-built_in">this</span>, mPackageWatchdog);<br>        mUidObserverController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UidObserverController</span>(mUiHandler);<br><br>        ...<br>        <span class="hljs-comment">// Acitivity管理</span><br>        mActivityTaskManager = atm;<br>        mActivityTaskManager.initialize(mIntentFirewall, mPendingIntentController,<br>                DisplayThread.get().getLooper());<br>        mAtmInternal = LocalServices.getService(ActivityTaskManagerInternal.class);<br><br>        <span class="hljs-comment">// 加入看门狗监控中</span><br>        Watchdog.getInstance().addMonitor(<span class="hljs-built_in">this</span>);<br>        Watchdog.getInstance().addThread(mHandler);<br>        ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>构造方法中主要是初始化，这里获取了三个线程，分别是系统线程也就是<code>SystemServer</code>所在的线程，然后是前台线程，最后是<code>UI</code>线程。接下来就是它的一些管理器，管理各个功能，这里大体上看下构造方法，然后回到启动方法<code>start</code>中。</p><figure class="java highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="java hljs"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IActivityManager</span>.Stub<br>        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Watchdog</span>.Monitor, BatteryStatsImpl.BatteryCallback, ActivityManagerGlobalLock &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 发布电池状态服务</span><br>        mBatteryStatsService.publish();<br>        <span class="hljs-comment">// 发布app信息服务</span><br>        mAppOpsService.publish();<br>        <span class="hljs-comment">// 发布进程状态服务</span><br>        mProcessStats.publish();<br>        <span class="hljs-comment">// 将ActivityManagerInternal注册到本地服务，抽象方法，实现在其内部类InternalService中</span><br>        LocalServices.addService(ActivityManagerInternal.class, mInternal);<br>        <span class="hljs-comment">// 与LocalServices类一样</span><br>        LocalManagerRegistry.addManager(ActivityManagerLocal.class,<br>                (ActivityManagerLocal) mInternal);<br>        mActivityTaskManager.onActivityManagerInternalAdded();<br>        mPendingIntentController.onActivityManagerInternalAdded();<br>        mAppProfiler.onActivityManagerInternalAdded();<br>        CriticalEventLog.init();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>其实就是注册各种服务，注意在<code>AMS</code>中的很多服务都是<code>Binder</code>服务，因此需要注册到<code>ServiceManager</code>或者作为本地服务注册到<code>LocalServices</code>中。同样的，具体细节我们后面再看，到这里算是启动完成，然后我们再次回到<code>SystemServer</code>中，接下来是设置系统进程。</p><figure class="java highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="java hljs"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IActivityManager</span>.Stub<br>        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Watchdog</span>.Monitor, BatteryStatsImpl.BatteryCallback, ActivityManagerGlobalLock &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSystemProcess</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 注册AMS，以及其他服务</span><br>            ServiceManager.addService(Context.ACTIVITY_SERVICE, <span class="hljs-built_in">this</span>, <span class="hljs-comment">/* allowIsolated= */</span> <span class="hljs-literal">true</span>,<br>                    DUMP_FLAG_PRIORITY_CRITICAL | DUMP_FLAG_PRIORITY_NORMAL | DUMP_FLAG_PROTO);<br>            ...<br><br>            <span class="hljs-comment">// 获取应用信息，这里的包名固定为android，属于系统</span><br>            <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> mContext.getPackageManager().getApplicationInfo(<br>                    <span class="hljs-string">&quot;android&quot;</span>, STOCK_PM_FLAGS | MATCH_SYSTEM_ONLY);<br>            mSystemThread.installSystemApplicationInfo(info, getClass().getClassLoader());<br><br>            <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>                <span class="hljs-comment">// 构建一个进程记录，用于管理SystemServer进程</span><br>                <span class="hljs-type">ProcessRecord</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> mProcessList.newProcessRecordLocked(info, info.processName,<br>                        <span class="hljs-literal">false</span>,<br>                        <span class="hljs-number">0</span>,<br>                        <span class="hljs-literal">false</span>,<br>                        <span class="hljs-number">0</span>,<br>                        <span class="hljs-literal">null</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HostingRecord</span>(HostingRecord.HOSTING_TYPE_SYSTEM));<br>                app.setPersistent(<span class="hljs-literal">true</span>);<br>                app.setPid(MY_PID);<br>                app.mState.setMaxAdj(ProcessList.SYSTEM_ADJ);<br>                app.makeActive(mSystemThread.getApplicationThread(), mProcessStats);<br>                app.mProfile.addHostingComponentType(HOSTING_COMPONENT_TYPE_SYSTEM);<br>                addPidLocked(app);<br>                <span class="hljs-comment">// 更新最近使用进程</span><br>                updateLruProcessLocked(app, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>                <span class="hljs-comment">// 设置oom_adj，内存不足时会根据该值杀进程</span><br>                updateOomAdjLocked(OomAdjuster.OOM_ADJ_REASON_NONE);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<br>                    <span class="hljs-string">&quot;Unable to find android system package&quot;</span>, e);<br>        &#125;<br>        ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到，在这里<code>SystemServer</code>整个进程也是被当成了一个应用，其包名为<code>android</code>，然后交由<code>AMS</code>进行管理。继续往下看，就是发布系统的<code>ContentProvider</code>，这里就是从<code>ProcessList</code>中查询名为<code>system</code>的进程中的<code>ContentProvider</code>，然后进行注册。再次回到<code>SystemServer</code>中，在最后的其他进程也启动完毕后，会执行<code>AMS</code>的<code>ready</code>方法来表示其已完成启动。</p><p>到这里基本上<code>AMS</code>启动已经完成了，实际上来看<code>AMS</code>就是一个大管家类型的服务，虽然它管理很多的功能，但实际上这些功能都被拆分出一个一个的服务，由这些服务单独管理，然后<code>AMS</code>统筹处理。</p></div></article><div><div class="copyright note-warning post-note"><p></p><div class="post-data">本文发布于<span id="post-time"></span>天前，最后更新于<span id="update-time"></span>天前，内容可能会与最新版本有所差异。</div><script>document.addEventListener("DOMContentLoaded",function(){var e=new Date,t=new Date("Sun Oct 02 2022 15:21:11 GMT+0800");let n="Sun Oct 02 2022 15:21:11 GMT+0800";n="2025-01-13 15:07:11 +0800";var o=new Date(n),t=Math.floor((e-t)/864e5),e=Math.floor((e-o)/864e5);document.getElementById("post-time").innerText=t,document.getElementById("update-time").innerText=e})</script><p></p></div></div><div class="post-footer"><a href="/categories/Android-Framework/" class="post-footer-category">#&nbsp;Android Framework</a> <a href="/tags/AOSP/" class="post-footer-tag">#&nbsp;AOSP</a></div><div class="nav"><div class="nav-item-prev"><a href="/2023/01/14/sp-wp-refbase/" class="nav-link"><div><div class="nav-label">上一篇</div><div class="nav-title">Android智能指针</div></div></a></div><div class="nav-item-next"><a href="/2022/09/21/system_server/" class="nav-link"><div><div class="nav-label">下一篇</div><div class="nav-title">Java服务总管-system_server进程</div></div></a></div></div><div class="card card-content toc-card" id="mobiletoc"><div class="toc-header">目录</div><ol class="toc"><li class="toc-item toc-level-3"><a href="#ActivityManagerService" class="toc-link"><span class="toc-text">ActivityManagerService</span></a></li></ol></div></main><aside class="right-column"><div class="sticky-widescreen"><article class="card card-content"><div class="recent-posts-card"><div class="recent-posts-header">相关文章</div><div class="recent-posts-list"><div class="recent-posts-item"><div class="recent-posts-item-title">2022-09-21</div><a href="/2022/09/21/system_server/"><div class="recent-posts-item-content">Java服务总管-system_server进程</div></a></div><div class="recent-posts-item recent-posts-item-other"><div class="recent-posts-item-title">2022-08-12</div><a href="/2022/08/12/zygote/"><div class="recent-posts-item-content">Java进程祖先-zygote服务</div></a></div><div class="recent-posts-item recent-posts-item-other"><div class="recent-posts-item-title">2022-07-25</div><a href="/2022/07/25/logd/"><div class="recent-posts-item-content">Android logd日志服务</div></a></div><div class="recent-posts-item recent-posts-item-other"><div class="recent-posts-item-title">2022-06-03</div><a href="/2022/06/03/init/"><div class="recent-posts-item-content">Android Init进程</div></a></div><div class="recent-posts-item recent-posts-item-other"><div class="recent-posts-item-title">2022-05-13</div><a href="/2022/05/13/android-lint-language/"><div class="recent-posts-item-content">【翻译】Android Init Language</div></a></div></div></div></article><article class="card card-content"><div class="recent-posts-card"><div class="recent-posts-header">最近文章</div><div class="recent-posts-list"><div class="recent-posts-item"><div class="recent-posts-item-title">2023-09-06</div><a href="/2023/09/06/ffmpeg1/"><div class="recent-posts-item-content">FFmpeg编译so库文件</div></a></div><div class="recent-posts-item recent-posts-item-other"><div class="recent-posts-item-title">2023-08-27</div><a href="/2023/08/27/overscroll/"><div class="recent-posts-item-content">View自定义回弹动效</div></a></div><div class="recent-posts-item recent-posts-item-other"><div class="recent-posts-item-title">2023-07-11</div><a href="/2023/07/11/coroutine-2/"><div class="recent-posts-item-content">Kotlin协程的实现</div></a></div><div class="recent-posts-item recent-posts-item-other"><div class="recent-posts-item-title">2023-06-05</div><a href="/2023/06/05/flow-2/"><div class="recent-posts-item-content">SharedFlow、StateFlow、SafeFlow的区别</div></a></div></div></div></article></div></aside></div></div></div></div><script>let initCount=0;function initClipboard(){++initCount<2||new ClipboardJS(".btn-copy").on("success",function(n){n.clearSelection(),n.trigger.innerHTML=icon_yes,setTimeout(()=>{n.trigger.innerHTML=icon_copy},1e3)})}var addLazyload=function(){lozad(".lozad",{load:function(n){n.srcset=n.getAttribute("data-src")},loaded:function(n){n.classList.add("loaded")}}).observe()}</script><script>loadScript("/js/lib/lozad.min.js",addLazyload)</script><script>loadScript("/js/lib/toc-highlight-scroll.min.js",()=>{tocSetup(),addCopyButton(),initClipboard()})</script><script>loadScript("/js/lib/clipboard.min.js",()=>initClipboard())</script></body></html>